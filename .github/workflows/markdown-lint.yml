name: LiveLabs Markdown Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read

jobs:
  markdown-validation:
    name: Validate Markdown Formatting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get markdown files from PR
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            **/*.md
          files_ignore: |
            node_modules/**
            .github/**/*.md

      - name: Setup Node.js
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        if: steps.changed-files.outputs.any_changed == 'true'
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Running markdownlint on PR files..."
          echo "Files in PR: ${{ steps.changed-files.outputs.all_changed_files }}"
          markdownlint ${{ steps.changed-files.outputs.all_changed_files }} --config .markdownlint.json || true

      - name: Run LiveLabs format validation
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          chmod +x .github/scripts/validate-livelabs-markdown.sh
          .github/scripts/validate-livelabs-markdown.sh ${{ steps.changed-files.outputs.all_changed_files }}

      - name: Check image references exist
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Checking if referenced images exist..."
          MISSING=0
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            dir=$(dirname "$file")
            # Extract image paths from markdown
            images=$(grep -oE '!\[.*?\]\(images/[^)]+\)' "$file" | grep -oE 'images/[^)]+' || true)
            for img in $images; do
              full_path="$dir/$img"
              if [ ! -f "$full_path" ]; then
                echo "ERROR: Missing image in $file: $img"
                MISSING=1
              fi
            done
          done
          if [ $MISSING -eq 1 ]; then
            echo "Some referenced images are missing!"
            exit 1
          fi
          echo "All referenced images exist."

      - name: Check filename conventions
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Checking filename conventions..."
          INVALID=0
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            filename=$(basename "$file")
            lowercase=$(echo "$filename" | tr '[:upper:]' '[:lower:]')
            if [ "$filename" != "$lowercase" ]; then
              echo "ERROR: Filename must be lowercase: $file"
              INVALID=1
            fi
            if [[ "$filename" =~ [[:space:]] ]]; then
              echo "ERROR: Filename contains spaces: $file"
              INVALID=1
            fi
          done
          if [ $INVALID -eq 1 ]; then
            exit 1
          fi
          echo "All filenames follow conventions."

      - name: Summary
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## Markdown Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checked files from PR:" >> $GITHUB_STEP_SUMMARY
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "- $file" >> $GITHUB_STEP_SUMMARY
          done

      - name: No markdown files in PR
        if: steps.changed-files.outputs.any_changed != 'true'
        run: echo "No markdown files in this PR."
