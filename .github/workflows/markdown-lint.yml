name: LiveLabs Markdown Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  markdown-validation:
    name: Validate Markdown Formatting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find all markdown files
        id: find-files
        run: |
          # Find all markdown files, excluding node_modules and .github
          MD_FILES=$(find . -name "*.md" -type f \
            ! -path "./node_modules/*" \
            ! -path "./.github/*" \
            | sort)

          if [ -z "$MD_FILES" ]; then
            echo "No markdown files found"
            echo "has_files=false" >> $GITHUB_OUTPUT
          else
            echo "Found markdown files:"
            echo "$MD_FILES"
            # Store files in a file for later use (handles large file lists)
            echo "$MD_FILES" > /tmp/md_files.txt
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "file_count=$(echo "$MD_FILES" | wc -l | tr -d ' ')" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.find-files.outputs.has_files == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        if: steps.find-files.outputs.has_files == 'true'
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        if: steps.find-files.outputs.has_files == 'true'
        run: |
          echo "Running markdownlint on all markdown files..."
          # Use xargs to handle large file lists
          cat /tmp/md_files.txt | xargs markdownlint --config .markdownlint.json || true

      - name: Run LiveLabs format validation
        if: steps.find-files.outputs.has_files == 'true'
        run: |
          chmod +x .github/scripts/validate-livelabs-markdown.sh
          # Pass files to the validation script
          cat /tmp/md_files.txt | xargs .github/scripts/validate-livelabs-markdown.sh

      - name: Check image references exist
        if: steps.find-files.outputs.has_files == 'true'
        run: |
          echo "Checking if referenced images exist..."
          MISSING=0
          while IFS= read -r file; do
            dir=$(dirname "$file")
            # Extract image paths from markdown
            images=$(grep -oE '!\[.*?\]\(images/[^)]+\)' "$file" | grep -oE 'images/[^)]+' || true)
            for img in $images; do
              full_path="$dir/$img"
              if [ ! -f "$full_path" ]; then
                echo "ERROR: Missing image in $file: $img"
                MISSING=1
              fi
            done
          done < /tmp/md_files.txt
          if [ $MISSING -eq 1 ]; then
            echo "Some referenced images are missing!"
            exit 1
          fi
          echo "All referenced images exist."

      - name: Check filename conventions
        if: steps.find-files.outputs.has_files == 'true'
        run: |
          echo "Checking filename conventions..."
          INVALID=0
          while IFS= read -r file; do
            filename=$(basename "$file")
            lowercase=$(echo "$filename" | tr '[:upper:]' '[:lower:]')
            if [ "$filename" != "$lowercase" ]; then
              echo "ERROR: Filename must be lowercase: $file"
              INVALID=1
            fi
            if [[ "$filename" =~ [[:space:]] ]]; then
              echo "ERROR: Filename contains spaces: $file"
              INVALID=1
            fi
          done < /tmp/md_files.txt
          if [ $INVALID -eq 1 ]; then
            exit 1
          fi
          echo "All filenames follow conventions."

      - name: Summary
        if: always() && steps.find-files.outputs.has_files == 'true'
        run: |
          echo "## Markdown Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checked ${{ steps.find-files.outputs.file_count }} markdown files" >> $GITHUB_STEP_SUMMARY

      - name: No markdown files
        if: steps.find-files.outputs.has_files != 'true'
        run: echo "No markdown files found in repository."
