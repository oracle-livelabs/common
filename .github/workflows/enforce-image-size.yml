name: Enforce image size on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Detect oversized images (>1280px)
        id: scan
        shell: bash
        run: |
          set -euo pipefail
          MAX=1280

          git fetch --no-tags --prune origin "${GITHUB_BASE_REF}:${GITHUB_BASE_REF}" || true

          mapfile -d '' files < <(
            git diff --name-only --diff-filter=AM -z "origin/${GITHUB_BASE_REF}...HEAD" -- \
              '*.png' '*.jpg' '*.jpeg' '*.PNG' '*.JPG' '*.JPEG' || true
          )

          oversized=""
          for f in "${files[@]}"; do
            [[ -f "$f" ]] || continue

            dims="$(ffprobe -v error -select_streams v:0 \
              -show_entries stream=width,height \
              -of csv=p=0:s=x "$f" || true)"

            if [[ -z "$dims" ]]; then
              echo "Skipping unreadable image: $f"
              continue
            fi

            w="${dims%x*}"
            h="${dims#*x}"

            if [[ "$w" -gt "$MAX" || "$h" -gt "$MAX" ]]; then
              # Annotation shown in PR Checks UI
              echo "::error file=$f::Image is ${w}x${h}. Max allowed is ${MAX}px (either dimension)."
              oversized+="${f} (${w}x${h})\n"
            fi
          done

          if [[ -n "$oversized" ]]; then
            {
              echo "oversized<<EOF"
              echo -e "$oversized"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            echo "has_oversized=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_oversized=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on PR with fix instructions (best effort)
        if: steps.scan.outputs.has_oversized == 'true'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const marker = "<!-- image-size-check -->";
            const max = 1280;
            const oversized = `${{ steps.scan.outputs.oversized }}`.trim();

            const body =
              `${marker}\n` +
              `ðŸ‘‹ Thanks for the PR! Some images exceed **${max}px** (width or height).\n\n` +
              `**Oversized images:**\n` +
              "```\n" + oversized + "\n```\n\n" +
              `**How to fix (in your fork):**\n` +
              "```bash\n" +
              "chmod +x scripts/resize-images.sh\n" +
              "./scripts/resize-images.sh\n" +
              "git add -A\n" +
              "git commit -m \"Resize images to 1280px max\"\n" +
              "git push\n" +
              "```\n\n" +
              "If you donâ€™t see this comment on a fork PR, check the failing status output in the PR checks. ðŸ‘";

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number, per_page: 100 }
            );

            const existing = comments.find(
              c => c.user?.type === "Bot" && c.body?.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body
              });
            }

      - name: Fail if oversized images found
        if: steps.scan.outputs.has_oversized == 'true'
        run: |
          echo "Oversized images detected."
          echo "Fix locally in your fork:"
          echo "  chmod +x scripts/resize-images.sh"
          echo "  ./scripts/resize-images.sh"
          exit 1
